{% extends 'base.html' %}
{% load i18n static %}

<!-- Add CSRF token for AJAX requests -->
{% csrf_token %}

{% block content %}
<div class="main-container">
    <h1>{% trans 'Your Cart' %}</h1>
    
    {% if cart_change_messages %}
        {% for change_message in cart_change_messages %}
            <div class="alert alert-warning">
                <strong>{% trans 'Cart Updated:' %}</strong> {{ change_message }}
            </div>
        {% endfor %}
    {% endif %}
    
    {% if message %}
        <div class="alert alert-success">{{ message }}</div>
    {% endif %}
    {% if cart_items %}
    <table class="cart-table">
        <thead>
            <tr>
                <th>{% trans 'Product' %}</th>
                <th>{% trans 'Price' %}</th>
                <th>{% trans 'Quantity' %}</th>
                <th>{% trans 'Subtotal' %}</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for item in cart_items %}
            <tr data-product-id="{{ item.product.id }}">
                <td>
                    <a href="{% url 'category_or_product' item.product.slug %}" class="cart-product-link product-link">{{ item.product.name }}</a>
                </td>
                <td class="nowrap">{{ item.price }} zł</td>
                <td>
                    <div class="quantity-control">
                        <button type="button" class="qty-btn qty-down" onclick="updateCartQuantity({{ item.product.id }}, -1, {{ item.product.stock }})">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M3 8h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </button>
                        <input type="text" id="cart-qty-{{ item.product.id }}" value="{{ item.quantity }}" min="1" max="{{ item.product.stock }}" class="cart-qty-input" oninput="validateQuantity(this, {{ item.product.stock }})" onchange="updateCartQuantity({{ item.product.id }}, 0, {{ item.product.stock }}, this.value)" />
                        <button type="button" class="qty-btn qty-up" onclick="updateCartQuantity({{ item.product.id }}, 1, {{ item.product.stock }})">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                </td>
                <td class="bold item-subtotal" data-product-id="{{ item.product.id }}" data-price="{{ item.price }}">{{ item.subtotal }} zł</td>
                <td>
                    <button type="button" class="cta-btn btn-sm remove-btn" data-cart-remove="{{ item.product.id }}">{% trans 'Remove' %}</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="cart-total-row">
        <strong>{% trans 'Total' %}: <span id="cart-total">{{ total }}</span> zł</strong>
    </div>
    <div class="cart-checkout-row">
        <a href="/checkout/" class="cta-btn btn-primary checkout-btn shop-link">{% trans 'Proceed to checkout' %}</a>
    </div>
    {% else %}
    <div class="empty-cart-msg">{% trans 'Your cart is empty.' %}</div>
    <div class="cart-back-link">
        <a href="{% url 'shop:public_product_list' %}" class="shop-link">&larr; {% trans 'Back to shop' %}</a>
    </div>
    {% endif %}
</div>

<script>
function validateQuantity(input, maxStock) {
    let value = input.value.replace(/[^0-9]/g, '');
    if (value === '') {
        value = 1;
    } else {
        value = parseInt(value);
        if (value < 1) value = 1;
        if (value > maxStock) value = maxStock;
    }
    input.value = value;
}

// Legacy function - now handled by CartManager automatically
function updateCartQuantity(productId, change, maxStock, newValue = null) {
    // CartManager handles this automatically via event listeners
    // This function exists for backward compatibility only
    if (window.cartManager) {
        window.cartManager.updateCartQuantity(productId, change, maxStock, newValue);
    }
}

// Legacy function - now handled by CartManager automatically  
function removeFromCart(productId) {
    // CartManager handles this automatically via event listeners
    // This function exists for backward compatibility only
    if (window.cartManager) {
        window.cartManager.removeFromCart(productId);
    }
}
</script>
{% endblock %} 